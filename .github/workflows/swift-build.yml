name: Swift/Metal Build and Validation

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  swift-metal-build:
    name: Swift/Metal Compilation
    runs-on: macos-15

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Determine change scope (paths-filter)
      id: changes
      uses: dorny/paths-filter@v3
      with:
        filters: |
          swift:
            - 'Package.swift'
            - 'Sources/**'
            - '**/*.swift'
            - 'Resources/communication/*.metal'
            - 'shaders/*.metal'
          docs:
            - '**/*.md'

    - name: Short-circuit if no Swift or shader changes on PR
      if: github.event_name == 'pull_request' && steps.changes.outputs.swift != 'true'
      run: |
        echo "No Swift/shader changes detected; skipping build."
        exit 0

    - name: Set up Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Cache Swift dependencies
      uses: actions/cache@v4
      with:
        path: |
          .build
          .swiftpm
          ~/Library/Caches/org.swift.swiftpm
        key: ${{ runner.os }}-swift-${{ hashFiles('Package.swift', 'Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-swift-
    
    - name: Check Swift version
      run: swift --version
    
    - name: Install/Detect Metal Toolchain (best-effort, non-fatal)
      shell: bash
      run: |
        set +e
        echo "ðŸ”Ž Checking for Metal CLI..."
        if xcrun -sdk macosx -f metal >/dev/null 2>&1; then
          # Try to invoke the tool; if it fails, attempt install
          if xcrun -sdk macosx metal --version >/dev/null 2>&1; then
            echo "METAL_PRESENT=1" >> "$GITHUB_ENV"
            echo "âœ… Metal compiler available"
          else
            echo "âš ï¸ metal found but not usable; attempting installation"
            xcodebuild -downloadComponent MetalToolchain >/dev/null 2>&1 || true
            if xcrun -sdk macosx metal --version >/dev/null 2>&1; then
              echo "METAL_PRESENT=1" >> "$GITHUB_ENV"
              echo "âœ… Metal compiler available after installation"
            else
              echo "METAL_PRESENT=0" >> "$GITHUB_ENV"
              echo "âŒ Metal toolchain still not usable; continuing without shader validation"
            fi
          fi
        else
          echo "âš ï¸ metal CLI not found; attempting installation"
          xcodebuild -downloadComponent MetalToolchain >/dev/null 2>&1 || true
          if xcrun -sdk macosx -f metal >/dev/null 2>&1 && xcrun -sdk macosx metal --version >/dev/null 2>&1; then
            echo "METAL_PRESENT=1" >> "$GITHUB_ENV"
            echo "âœ… Metal compiler available after installation"
          else
            echo "METAL_PRESENT=0" >> "$GITHUB_ENV"
            echo "âŒ Metal toolchain not present on runner after install attempt; continuing"
          fi
        fi
        set -e
    
    - name: Build with SwiftPM
      run: |
        echo "Building with Swift Package Manager..."
        set -o pipefail
        swift build --configuration debug -v | tee build-swift.log
        exit_code=${PIPESTATUS[0]}
        if [ $exit_code -ne 0 ]; then
          echo "âŒ swift build failed with exit code $exit_code"
          echo "Last 200 lines of build log:" && tail -n 200 build-swift.log || true
          exit $exit_code
        fi
        echo "âœ… swift build completed"
    
    - name: Upload build log (always)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: swift-build-log
        path: build-swift.log
        retention-days: 7
    
    - name: Validate Metal shader files
      if: env.METAL_PRESENT == '1'
      run: |
        echo "Validating Metal shader files..."
        SHADER_ERRORS=0
        
        for shader in shaders/*.metal Resources/communication/*.metal; do
          if [ -f "$shader" ]; then
            echo "Validating $shader..."
            if xcrun -sdk macosx metal -c "$shader" -o /tmp/$(basename "$shader" .metal).air; then
              echo "âœ… $shader compiled successfully"
            else
              echo "âŒ $shader failed to compile"
              SHADER_ERRORS=$((SHADER_ERRORS + 1))
            fi
          fi
        done
        
        if [ $SHADER_ERRORS -gt 0 ]; then
          echo "âŒ $SHADER_ERRORS shader(s) failed to compile"
          exit 1
        else
          echo "âœ… All Metal shader files compiled successfully"
        fi
    
    - name: Test built executable exists
      run: |
        echo "Checking built executable..."
        if [ -x ".build/debug/MetalShaderStudio" ]; then
          echo "âœ… .build/debug/MetalShaderStudio exists"
          file .build/debug/MetalShaderStudio
        else
          echo "âŒ .build/debug/MetalShaderStudio not found"
          exit 1
        fi
    
    - name: Archive build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: metal-shader-studio-build
        path: |
          .build/debug/MetalShaderStudio
          **/*.air
        retention-days: 7
    
    - name: Build summary
      run: |
        echo "## ðŸ—ï¸ Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Swift compilation successful" >> $GITHUB_STEP_SUMMARY  
        echo "- âœ… Metal shaders validated" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… MetalShaderStudio executable created" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“¦ Build artifacts uploaded" >> $GITHUB_STEP_SUMMARY
